# 配置迁移指南

## 概述

本项目已重构配置管理系统，将所有敏感信息和配置项集中到 `config.yaml` 文件中管理。

## 为什么要重构配置？

### 之前的问题
- **敏感信息分散**: API Key、用户 URL 等敏感信息硬编码在多个文件中
- **修改困难**: 需要在多个文件中修改相同的配置
- **安全风险**: 容易误将敏感信息提交到 Git

### 重构后的优势
- ✅ **集中管理**: 所有配置统一在 `config.yaml` 中
- ✅ **易于修改**: 只需修改一个文件
- ✅ **安全保护**: `config.yaml` 已加入 `.gitignore`
- ✅ **类型安全**: 配置加载器提供类型检查和默认值

## 配置文件说明

### 1. config.yaml (统一配置文件)

**位置**: 项目根目录  
**用途**: 管理所有敏感信息和应用配置  
**安全**: 已加入 `.gitignore`，不会被提交到 Git

**主要配置项**:
```yaml
# 抖音目标用户
douyin:
  target_user_url: "https://www.douyin.com/user/YOUR_USER_ID"

# AI API Key
ai:
  dashscope_api_key: "YOUR_API_KEY"

# 调度配置
scheduler:
  interval_minutes: 300
  timezone: "Asia/Shanghai"
  max_workers: 0

# 上传配置
upload:
  category: "CUTE_PETS"
  publish_date: 0
  delete_after_upload: false
```

### 2. my_apps.yaml (F2 框架配置)

**位置**: 项目根目录  
**用途**: F2 框架的配置文件  
**内容**: 抖音 Cookie、请求头、代理等

**注意**: 此文件仍需手动配置 Cookie

## 迁移步骤

### 步骤 1: 创建配置文件

```bash
# 复制示例配置
copy config.yaml.example config.yaml
```

### 步骤 2: 填写必需配置

编辑 `config.yaml`，填写以下必需项:

1. **抖音目标用户 URL**
   ```yaml
   douyin:
     target_user_url: "https://www.douyin.com/user/MS4wLjABAAAA..."
   ```
   
   获取方式: 打开抖音用户主页，复制完整 URL

2. **阿里云百炼 API Key**
   ```yaml
   ai:
     dashscope_api_key: "sk-xxxxxxxxxxxxxxxx"
   ```
   
   获取方式: https://bailian.console.aliyun.com/

### 步骤 3: 调整可选配置

根据需要调整以下配置:

- `scheduler.interval_minutes`: 调度间隔 (建议 5-60 分钟)
- `scheduler.timezone`: 时区 (默认 Asia/Shanghai)
- `upload.category`: 视频分类 (默认 CUTE_PETS)
- `upload.delete_after_upload`: 上传后是否删除本地视频

### 步骤 4: 测试配置

```bash
# 测试配置加载
python config_loader.py
```

如果配置正确，会显示:
```
配置加载测试
============================================================
抖音目标 URL: https://www.douyin.com/user/...
API Key: sk-5930ab55016b4bd...
调度间隔: 300 分钟
时区: Asia/Shanghai
...
✅ 配置加载成功!
```

### 步骤 5: 运行程序

配置完成后，可以正常运行程序:

```bash
# 完整流程
python main.py

# 独立去重
python standalone_dedup.py

# 独立上传
python standalone_upload.py
```

## 受影响的文件

以下文件已重构以使用新的配置系统:

1. **config_loader.py** (新增)
   - 配置加载器，提供统一的配置访问接口

2. **main.py**
   - `AppConfig` 类现在从 `config.yaml` 加载配置
   - 移除了硬编码的 URL 和时间配置

3. **standalone_upload.py**
   - `StandaloneUploadConfig` 类使用配置加载器
   - 移除了硬编码的 API Key

4. **Upload/vx_upload.py**
   - `AIAnalyzer` 类使用配置加载器获取 API Key

## 配置项对照表

| 旧位置 | 新位置 | 说明 |
|--------|--------|------|
| `main.py` 第 77 行 | `config.yaml` → `douyin.target_user_url` | 抖音目标用户 URL |
| `main.py` 第 79 行 | `config.yaml` → `scheduler.interval_minutes` | 调度间隔 |
| `main.py` 第 80 行 | `config.yaml` → `scheduler.timezone` | 时区 |
| `standalone_upload.py` 第 60 行 | `config.yaml` → `ai.dashscope_api_key` | AI API Key |
| `standalone_upload.py` 第 63 行 | `config.yaml` → `upload.category` | 视频分类 |
| `Upload/vx_upload.py` 第 28 行 | `config.yaml` → `ai.dashscope_api_key` | AI API Key |

## 常见问题

### Q1: 配置文件加载失败
**错误**: `FileNotFoundError: 配置文件不存在: config.yaml`

**解决**:
```bash
copy config.yaml.example config.yaml
```

### Q2: 必需配置项为空
**错误**: `ValueError: 必需的配置项不存在或为空: ai.dashscope_api_key`

**解决**: 编辑 `config.yaml`，填写对应的配置项

### Q3: YAML 格式错误
**错误**: `yaml.scanner.ScannerError: ...`

**解决**: 检查 `config.yaml` 的格式，确保:
- 使用空格缩进 (不要使用 Tab)
- 字符串值使用引号包裹
- 冒号后面有空格

### Q4: 如何查看当前配置
**方法 1**: 运行测试脚本
```bash
python config_loader.py
```

**方法 2**: 在 Python 中导入
```python
from config_loader import config
print(config.douyin_target_url)
print(config.dashscope_api_key)
```

## 安全建议

1. **不要提交 config.yaml**
   - 此文件已加入 `.gitignore`
   - 包含敏感信息，切勿提交到 Git

2. **使用环境变量 (可选)**
   - 可以通过环境变量覆盖配置
   - 适合在 CI/CD 环境中使用

3. **定期更新 API Key**
   - 建议定期更换 API Key
   - 如果 Key 泄露，立即在控制台禁用

4. **备份配置文件**
   - 在本地安全位置备份 `config.yaml`
   - 避免配置丢失

## 回退到旧版本

如果遇到问题需要回退，可以:

1. 恢复旧的文件版本
2. 手动修改硬编码的配置项

但建议解决配置问题而不是回退，新的配置系统更安全、更易维护。

## 技术支持

如有问题，请:
1. 查看 [README.md](README.md) 中的常见问题
2. 运行 `python config_loader.py` 测试配置
3. 提交 [Issue](https://github.com/toki-plus/video-mover/issues)
